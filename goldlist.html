<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">

    <title>Document</title>
</head>
<style type="text/css">
.hover {
    transition: 0.3s;
}

.hover:hover {
    background-color: silver;
}
</style>

<body>    
    <div class="container">
        <nav id='titleHr' class="navbar navbar-dark bg-dark">
            <a class="navbar-brand" href="#">Gold List</a>
            <h2><span id='nav_date' class="badge badge-light"></span></h2>
        </nav>

        <div id='list'>
        </div>

        <button type="button" class="btn btn-dark btn-lg" onclick="NewEntry()"> New Entry </button>

        <a class='btn btn-dark btn-lg' href='https://derekhearn.com/notepad.html?id=965f9d11dde1433ba574e3cd82745223'>
            Edit JSON Directly
        </a>
    </div>

</body>


<script>
    const api = location.origin + '/';
    const redisPath = api + 'redis/';
    const notepadPath = location.origin + '/notepad.html';
    const titleHr = document.getElementById('titleHr');
    const id = '965f9d11dde1433ba574e3cd82745223';
    const today = new Date();

    document.getElementById('nav_date').innerText = today.toLocaleDateString();


    function NewEntry() {
        
        // Get new ID
        const xhr = new XMLHttpRequest();
        const url = redisPath + 'new';
        xhr.open("GET", url);
        xhr.send();

        xhr.onreadystatechange = (e) => {
            if (xhr.readyState == XMLHttpRequest.DONE) {

                const id = xhr.responseText;
                const today = new Date();
                let month = (today.getMonth()+1).toString();
                let day = today.getDay().toString();
                if (month.length < 2) month = '0' + month;
                if (day.length < 2) day = '0' + day;
                const entry = {
                    'dates':[today.getFullYear().toString() + month + day],
                    'link': notepadPath + '?id=' + id
                };
                console.log(entry);
                AddEventHashes(entry);
                entry['buttonText'] = 'New Entry!';

                console.log(entry);

                const card = NewEntryCard(entry);
                const deck = document.getElementById('deck');
                deck.appendChild(card);
            }
        }
    }

    function AddEventHashes(entry){
        const lastDateString = entry['dates'].slice(-1)[0];
            entry['lastDate'] = new Date(lastDateString.slice(0, 4) + '-' + lastDateString.slice(4,
                6) + '-' + lastDateString.slice(6));
            let dueDate = new Date(entry['lastDate']);
            dueDate.setDate(dueDate.getDate() + 14);
            entry['dueDate'] = dueDate;
            entry['buttonText'] = dueDate.toLocaleDateString();
    }

    function NewCardDeck (entries) {
        const d = document.getElementById('list');
        const cardDeck = document.createElement('div');
        cardDeck.id = 'deck';
        cardDeck.className = 'card-group';
        
        for (let i = 0; i < entries.length; i++) {
            AddEventHashes(entries[i]);
        }

        entries.sort((l, r) => l['dueDate'] - r['dueDate'])

        for (let i = 0; i < entries.length; i++) {
            cardDeck.appendChild(NewEntryCard(entries[i]));
        }
        d.appendChild(cardDeck);

        
    }

    function NewEntryCard(entry) {
        const dueDate = entry['dueDate'];
        const lastDate = entry['lastDate'];
        const timesStudied = entry['dates'].length;

        const card = document.createElement('div');
        card.className = 'card hover';

        const cardBody = document.createElement('div');
        cardBody.className = 'card-body';
        card.append(cardBody);

        const a = document.createElement('a');
        const copy = entry['buttonText'];
        a.appendChild(document.createTextNode(copy));
        a.href = entry['link'];
        if(today > dueDate) {
            a.className = 'btn btn-warning shadow stretched-link'
        } else {
            a.className = 'btn btn-dark shadow-sm stretched-link'

        }
        cardBody.appendChild(a);

        const d1 = document.createElement('div');
        d1.appendChild(document.createTextNode('Due: ' + dueDate.toLocaleDateString()));
        cardBody.appendChild(d1);

        const d2 = document.createElement('div');
        d2.appendChild(document.createTextNode('Times: ' + timesStudied));
        cardBody.appendChild(d2);

        const d3 = document.createElement('div');
        d3.appendChild(document.createTextNode('Last Studied: ' + lastDate.toLocaleDateString()));
        cardBody.appendChild(d3);

        return card;
    }

    function GetData() {
        const xhr = new XMLHttpRequest();
        const url = redisPath + '?search=' + id;
        xhr.open("GET", url);
        xhr.send();
        xhr.onreadystatechange = (e) => {
            if (xhr.readyState == XMLHttpRequest.DONE) {
                const value = JSON.parse(xhr.responseText)[id];
                const valueHash = JSON.parse(value);

                let entries = valueHash['entries'];
                NewCardDeck(entries);
            }
        }
    }

    GetData();
</script>


</html>